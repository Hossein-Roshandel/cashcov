# Base stage with system dependencies
FROM golang:1.25.1-bookworm AS base

# Install system dependencies in one layer to reduce image size
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    make \
    build-essential \
    ca-certificates \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create vscode user for dev container
RUN groupadd --gid 1000 vscode \
    && useradd --uid 1000 --gid vscode --shell /bin/bash --create-home vscode \
    && echo 'vscode ALL=(root) NOPASSWD:ALL' > /etc/sudoers.d/vscode \
    && chmod 0440 /etc/sudoers.d/vscode

# Builder stage for installing Go tools and dependencies
FROM base AS builder

# Set Go environment variables
ENV GO111MODULE=on
ENV CGO_ENABLED=0
ENV GOOS=linux
ENV GOPATH=/home/vscode/go
ENV PATH=$GOPATH/bin:/usr/local/go/bin:$PATH

# Switch to vscode user
USER vscode
WORKDIR /workspace

# Copy project files
COPY Makefile go.mod go.sum ./
RUN make dev-setup


FROM base AS final

# Set Go environment variables
ENV GO111MODULE=on
ENV CGO_ENABLED=0
ENV GOOS=linux
ENV GOPATH=/home/vscode/go
ENV PATH=$GOPATH/bin:/usr/local/go/bin:/home/vscode/.local/bin:$PATH

# Copy Go tools and module cache from builder
COPY --from=builder --chown=vscode:vscode /home/vscode /home/vscode
COPY --from=builder  /usr/local/go /usr/local/go
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/


# Switch to vscode user
USER vscode

RUN uv tool install pre-commit --with pre-commit-uv

WORKDIR /workspace

# Default command for dev container
CMD ["bash"]
